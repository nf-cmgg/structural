/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for defining DSL2 per module options and publishing paths
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Available keys to override module options:
        ext.args   = Additional arguments appended to command in module.
        ext.args2  = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3  = Third set of arguments appended to command in module (multi-tool modules).
        ext.prefix = File name prefix for output files.
----------------------------------------------------------------------------------------
*/

process {
    def callers = params.callers.tokenize(",")
    def sv_callers = callers.intersect(params.sv_callers)
    def output_callers = params.output_callers

    publishDir = [
        enabled: false
    ]

    /*
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        MAIN FLOW
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    */


    /*
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        STRUCTURAL VARIANT CALLING
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    */

    if(sv_callers){

        //
        // Delly
        //

        if("delly" in callers){
            withName: '^.*:BAM_VARIANT_CALLING_DELLY:DELLY_CALL\$' {
                ext.args = {"--svtype ${params.delly_sv_types} --map-qual ${params.delly_map_qual} --min-clique-size ${params.delly_min_clique_size}"}
                ext.suffix = "vcf"
                ext.prefix = { "${meta.id}.sv" }
                publishDir = [[
                    enabled: sv_callers.size() == 1,
                    overwrite: true,
                    path: { "${params.outdir}/${meta.id}" },
                    mode: params.publish_dir_mode,
                    saveAs: { filename -> filename != "versions.yml" ? filename : null }
                ],[
                    enabled: output_callers,
                    overwrite: true,
                    path: { "${params.outdir}/${meta.id}/delly" },
                    mode: params.publish_dir_mode,
                    saveAs: { filename -> filename != "versions.yml" ? filename : null }
                ]]
            }
        }

        //
        // Whamg
        //

        if("whamg" in callers){
            withName: '^.*:BAM_VARIANT_CALLING_WHAMG:WHAMG\$' {
                ext.prefix = { "${meta.id}" }
                ext.args = {[
                    meta.region ? "-r ${meta.region}" : "" ,
                    "-z"
                ].join(' ').trim()}
                publishDir = [[
                    enabled: sv_callers.size() == 1,
                    overwrite: true,
                    path: { "${params.outdir}/${meta.id}" },
                    mode: params.publish_dir_mode,
                    saveAs: { filename -> filename != "versions.yml" ? filename : null }
                ],[
                    enabled: output_callers,
                    overwrite: true,
                    path: { "${params.outdir}/${meta.id}/whamg" },
                    mode: params.publish_dir_mode,
                    saveAs: { filename -> filename != "versions.yml" ? filename : null }
                ]]
            }
        }

        //
        // Manta
        //

        if("manta" in callers){
            withName: '^.*:BAM_VARIANT_CALLING_MANTA:MANTA_CONVERTINVERSION\$' {
                ext.prefix = { "${meta.id}.sv" }
                publishDir = [[
                    enabled: sv_callers.size() == 1,
                    overwrite: true,
                    path: { "${params.outdir}/${meta.id}" },
                    mode: params.publish_dir_mode,
                    saveAs: { filename -> filename != "versions.yml" ? filename : null }
                ],[
                    enabled: output_callers,
                    overwrite: true,
                    path: { "${params.outdir}/${meta.id}/manta" },
                    mode: params.publish_dir_mode,
                    saveAs: { filename -> filename != "versions.yml" ? filename : null }
                ]]
            }
        }

        //
        // Scramble
        //

        if("scramble" in callers){
            withName: '.*:BAM_VARIANT_CALLING_SCRAMBLE:SCRAMBLE_CLUSTERANALYSIS\$' {
                ext.args = "--eval-meis"
            }
        }

        //
        // Smoove
        //

        if("smoove" in callers){
            withName: '^.*:BAM_VARIANT_CALLING_SMOOVE:BCFTOOLS_SORT\$' {
                ext.prefix = { "${meta.id}.sv" }
                publishDir = [[
                    enabled: sv_callers.size() == 1,
                    overwrite: true,
                    path: { "${params.outdir}/${meta.id}" },
                    mode: params.publish_dir_mode,
                    saveAs: { filename -> filename != "versions.yml" ? filename : null }
                ],[
                    enabled: output_callers,
                    overwrite: true,
                    path: { "${params.outdir}/${meta.id}/smoove" },
                    mode: params.publish_dir_mode,
                    saveAs: { filename -> filename != "versions.yml" ? filename : null }
                ]]
            }

            withName: '^.*:BAM_VARIANT_CALLING_SMOOVE:TABIX_TABIX\$' {
                publishDir = [[
                    enabled: sv_callers.size() == 1,
                    overwrite: true,
                    path: { "${params.outdir}/${meta.id}" },
                    mode: params.publish_dir_mode,
                    saveAs: { filename -> filename != "versions.yml" ? filename : null }
                ],[
                    enabled: output_callers,
                    overwrite: true,
                    path: { "${params.outdir}/${meta.id}/smoove" },
                    mode: params.publish_dir_mode,
                    saveAs: { filename -> filename != "versions.yml" ? filename : null }
                ]]
            }
        }

        //
        // Gridss
        //

        if("gridss" in callers){
            withName: '^.*:BAM_VARIANT_CALLING_GRIDSS:GRIDSS_GRIDSS\$' {
                ext.prefix = { "${meta.id}.sv" }
                ext.args = "--steps preprocess,assemble,call"
                publishDir = [[
                    enabled: sv_callers.size() == 1,
                    overwrite: true,
                    path: { "${params.outdir}/${meta.id}" },
                    mode: params.publish_dir_mode,
                    saveAs: { filename -> filename ==~ /^.*.vcf.gz$/ ? filename : null }
                ],[
                    enabled: output_callers,
                    overwrite: true,
                    path: { "${params.outdir}/${meta.id}/gridss" },
                    mode: params.publish_dir_mode,
                    saveAs: { filename -> filename ==~ /^.*.vcf.gz$/ ? filename : null }
                ]]
            }

            withName: '^.*:BAM_VARIANT_CALLING_GRIDSS:TABIX_TABIX\$' {
                publishDir = [[
                    enabled: sv_callers.size() == 1,
                    overwrite: true,
                    path: { "${params.outdir}/${meta.id}" },
                    mode: params.publish_dir_mode,
                    saveAs: { filename -> filename != "versions.yml" ? filename : null }
                ],[
                    enabled: output_callers,
                    overwrite: true,
                    path: { "${params.outdir}/${meta.id}/gridss" },
                    mode: params.publish_dir_mode,
                    saveAs: { filename -> filename != "versions.yml" ? filename : null }
                ]]
            }
        }

        //
        // Standardize VCFs
        //

        withName: "^.*:VCF_STANDARDIZE_VIOLA:VIOLA\$" {
            ext.prefix = {"${meta.id}_${meta.caller}"}
            ext.args = { meta.read_length ? "--read_length ${meta.read_length}" : ""}
        }

        //
        // Merge VCFS
        //

        if(sv_callers.size() > 1){
            withName: "^.*:VCF_MERGE_JASMINE:JASMINESV\$" {
                ext.args = "min_support=${params.callers_support} --allow_intrasample"
            }

            withName: "^.*:VCF_MERGE_JASMINE:REHEADER_CALLED_VCFS\$" {
                ext.prefix = { "${meta.id}_reheadered" }
                ext.args2 = "--output-type z"
            }

            withName: "^.*:VCF_MERGE_JASMINE:BCFTOOLS_SORT\$" {
                ext.prefix = { "${meta.id}.sv" }
                publishDir = [
                    enabled: !params.annotate,
                    overwrite: true,
                    path: { "${params.outdir}/${meta.id}" },
                    mode: params.publish_dir_mode,
                    saveAs: { filename -> filename != "versions.yml" ? filename : null }
                ]
            }

            withName: "^.*:VCF_MERGE_JASMINE:TABIX_TABIX\$" {
                publishDir = [
                    enabled: !params.annotate,
                    overwrite: true,
                    path: { "${params.outdir}/${meta.id}" },
                    mode: params.publish_dir_mode,
                    saveAs: { filename -> filename != "versions.yml" ? filename : null }
                ]
            }
        } else {
            withName: "^.*:BAM_STRUCTURAL_VARIANT_CALLING:REHEADER_CALLED_VCFS\$" {
                ext.args2 = "--output-type z"
            }

            withName: "^.*:BAM_STRUCTURAL_VARIANT_CALLING:BCFTOOLS_SORT\$" {
                ext.prefix = { "${meta.id}.sorted" }
            }
        }

        /*
        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
            ANNOTATION
        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        */

        if(params.annotate){

            withName: "^.*:VCF_ANNOTATE_VEP_ANNOTSV_VCFANNO:BCFTOOLS_FILTER\$" {
                ext.prefix = {"${meta.id}.filter"}
                ext.args = "-e 'GT=\"ref\"'"
            }

            withName: "^.*VCF_ANNOTATE_VEP_ANNOTSV_VCFANNO:ANNOTSV_ANNOTSV\$" {
                ext.args = "-vcf 1 -SVminSize 20"
                ext.prefix = {"${meta.id}.annot"}
            }

            withName: "^.*VCF_ANNOTATE_VEP_ANNOTSV_VCFANNO:TABIX_ANNOTSV\$" {
                ext.prefix = params.annotsv_file_name
            }

            withName: "^.*VCF_ANNOTATE_VEP_ANNOTSV_VCFANNO:ENSEMBLVEP_VEP\$" {
                container = {workflow.stubRun ? "biocontainers/ensembl-vep:108.2--pl5321h4a94de4_0" : "docker.io/nfcore/vep:${params.vep_version}.${params.genome}"}
                ext.prefix = {"${meta.id}_annotated"}
                ext.args = {[
                    // specify we use VCF files
                    '--format vcf',
                    // don't contact external db
                    '--offline',
                    // increase buffer_size to speed up analysis
                    '--buffer_size 100000',
                    // output format options
                    '--vcf --compress_output bgzip --force_overwrite',
                    // co-located variant info
                    '--check_existing',
                    // specific options for structural variants
                    '--overlaps', // TODO define the best configuration for --max_sv_size, --batch_size, --check_svs and --database
                    // plugins
                    (params.vep_phenotypes) ? "--plugin Phenotypes,file=${params.phenotypes.split('/')[-1]}": ""
                ].join(' ').trim()}
            }

            withName: "^.*VCF_ANNOTATE_VEP_ANNOTSV_VCFANNO:VCFANNO\$" {
                ext.args = "-permissive-overlap"
            }

            withName: "^.*VCF_ANNOTATE_VEP_ANNOTSV_VCFANNO:TABIX_ANNOTATED\$" {
                ext.prefix = { "${meta.id}.sv" }
                publishDir = [
                    enabled: true,
                    overwrite: true,
                    path: { "${params.outdir}/${meta.id}" },
                    mode: params.publish_dir_mode,
                    saveAs: { filename -> filename != "versions.yml" ? filename : null }
                ]
            }
        }
    }

    /*
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        REPEAT ESTIMATION
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    */

    if(callers.intersect(params.repeats_callers)){

        withName: "^.*BAM_REPEAT_ESTIMATION_EXPANSIONHUNTER:BCFTOOLS_FILTER\$" {
            ext.args = "--output-type z -e 'GT=\"mis\"'"
            ext.prefix = { "${meta.id}.repeats" }
            publishDir = [[
                enabled: true,
                overwrite: true,
                path: { "${params.outdir}/${meta.id}" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename != "versions.yml" ? filename : null }
            ],[
                enabled: output_callers,
                overwrite: true,
                path: { "${params.outdir}/${meta.id}/expansionhunter" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename != "versions.yml" ? filename : null }
            ]]
        }

        withName: "^.*BAM_REPEAT_ESTIMATION_EXPANSIONHUNTER:TABIX_TABIX\$" {
            publishDir = [[
                enabled: true,
                overwrite: true,
                path: { "${params.outdir}/${meta.id}" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename != "versions.yml" ? filename : null }
            ],[
                enabled: output_callers,
                overwrite: true,
                path: { "${params.outdir}/${meta.id}/expansionhunter" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename != "versions.yml" ? filename : null }
            ]]
        }
    }

    /*
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        CONCAT OUTPUTS
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    */

    if(params.concat_output){

        withName: "^.*VCF_CONCAT_BCFTOOLS:BCFTOOLS_CONCAT\$" {
            ext.args = "--output-type z"
            ext.prefix = { "${meta.id}.concat" }
            publishDir = [
                enabled: true,
                overwrite: true,
                path: { "${params.outdir}/${meta.id}" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename != "versions.yml" ? filename : null }
            ]
        }

        withName: "^.*VCF_CONCAT_BCFTOOLS:TABIX_TABIX\$" {
            publishDir = [
                enabled: true,
                overwrite: true,
                path: { "${params.outdir}/${meta.id}" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename != "versions.yml" ? filename : null }
            ]
        }
    }

    /*
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        REST OF THE PIPELINE
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    */

    withName: CUSTOM_DUMPSOFTWAREVERSIONS {
        publishDir = [
            enabled: true,
            path: { "${params.outdir}/pipeline_info" },
            mode: params.publish_dir_mode,
            pattern: '*_versions.yml'
        ]
    }

}

/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for defining DSL2 per module options and publishing paths
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Available keys to override module options:
        ext.args   = Additional arguments appended to command in module.
        ext.args2  = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3  = Third set of arguments appended to command in module (multi-tool modules).
        ext.prefix = File name prefix for output files.
----------------------------------------------------------------------------------------
*/

process {

    publishDir = [
        enabled: false
    ]

    /*
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        MAIN FLOW
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    */

    withName: ENSEMBLVEP_DOWNLOAD {
        ext.args = "--AUTO c --CONVERT --NO_BIOPERL --NO_TEST --NO_UPDATE"
    }

    withName: BWA_INDEX {
        ext.prefix = { "${fasta}" }
    }

    /*
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        STRUCTURAL VARIANT CALLING
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    */

    //
    // Svync (used for all callers)
    //

    withName: SVYNC {
        ext.prefix = { "${meta.id}.svync.${meta.caller}"}
    }

    //
    // Delly
    //

    withName: "^.*BAM_VARIANT_CALLING_DELLY:DELLY_CALL\$" {
        ext.args = {"--svtype ${params.delly_sv_types} --map-qual ${params.delly_map_qual} --min-clique-size ${params.delly_min_clique_size}"}
        ext.suffix = "vcf"
        ext.prefix = { "${meta.id}.delly" }
    }

    //
    // Whamg
    //

    // if("whamg" in callers){
    //     withName: "^.*BAM_VARIANT_CALLING_WHAMG:WHAMG\$" {
    //         ext.prefix = { "${meta.id}.whamg" }
    //         ext.args = {[
    //             meta.region ? "-r ${meta.region}" : "" ,
    //             "-z"
    //         ].join(' ').trim()}
    //     }
    // }

    //
    // Manta
    //

    withName: "^.*BAM_VARIANT_CALLING_MANTA:GAWK\$" {
        ext.suffix = "bed"
        ext.prefix = "contigs"
        ext.args2 = '\'BEGIN {FS="\t"}; \$1 ~ /^chr[1-9XY][1-9]?\$/ {print \$1 FS "0" FS \$2 }\''
    }

    withName: "^.*MANTA_.*\$" {
        container = "quay.io/cmgg/manta:1.6.0"
    }

    withName: "^.*BAM_VARIANT_CALLING_MANTA:MANTA_GERMLINE\$" {
        label = "process_high"
        cpus  = { 20 * task.attempt }
    }

    withName: "^.*BAM_VARIANT_CALLING_MANTA:MANTA_CONVERTINVERSION\$" {
        ext.prefix = { "${meta.id}.manta" }
    }

    //
    // Scramble
    //

    // if("scramble" in callers){
    //     withName: "^.*.*:BAM_VARIANT_CALLING_SCRAMBLE:SCRAMBLE_CLUSTERANALYSIS\$" {
    //         ext.args = "--eval-meis"
    //     }
    // }

    //
    // Smoove
    //

    withName: "^.*BAM_VARIANT_CALLING_SMOOVE:BCFTOOLS_SORT\$" {
        ext.prefix = { "${meta.id}.smoove" }
        ext.args = "--output-type z --write-index=tbi"
    }

    //
    // Gridss
    //

    // withName: "^.*BAM_VARIANT_CALLING_GRIDSS:GRIDSS_GRIDSS\$" {
    //     cpus   = { 8     * task.attempt }
    //     memory = { 32.GB * task.attempt }
    //     ext.prefix = { "${meta.id}.gridss" }
    //     ext.args = { [
    //         "--steps preprocess,assemble,call",
    //         "--otherjvmheap ${task.memory.toGiga() > 10 ? 4 : 2}g",
    //         "--jvmheap ${task.memory.toGiga() > 10 ? task.memory.toGiga() - 8 : 2}g"
    //     ].join(" ") }
    // }

    // withName: "^.*BAM_VARIANT_CALLING_GRIDSS:VIOLA\$" {
    //     time   = { 20.h  * task.attempt }
    //     ext.prefix = { "${meta.id}.viola" }
    //     ext.args = { meta.read_length ? "--read_length ${meta.read_length}" : ""}
    // }

    // withName: "^.*BAM_VARIANT_CALLING_GRIDSS:BCFTOOLS_SORT\$" {
    //     ext.prefix = { "${meta.id}.gridss" }
    // }

    /*
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        COPY NUMBER VARIATION
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    */

    withName: "^.*BAM_VARIANT_CALLING_QDNASEQ:QDNASEQ.*\$" {
        cpus = 1
        memory = { 50.GB * task.attempt }
        ext.prefix = { "${meta.id}.qdnaseq" }
    }

    withName: "^.*BAM_VARIANT_CALLING_QDNASEQ:GAWK\$" {
        ext.prefix = { "${meta.id}.qdnaseq.abberations" }
        ext.suffix = "bed"
        ext.args = "-F '\\t'"
        ext.args2 = "'{ if (\$5 >= ${params.qdnaseq_cnv_ratio} || \$5 <= -${params.qdnaseq_cnv_ratio} || \$5 == \"Inf\") { print } }'"
    }

    withName: "^.*BAM_VARIANT_CALLING_WISECONDORX:WISECONDORX_PREDICT\$" {
        ext.args = "--seed 0 --bed --plot"
        memory = { 50.GB * task.attempt }
        ext.prefix = { "${meta.id}.wisecondorx" }
    }

    withName: BEDGOVCF {
        ext.prefix = { "${meta.id}.${meta.caller}" }
        ext.args = { meta.caller == "qdnaseq" ? "--skip 1" : "--header" }
    }

    /*
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        JASMINE MERGE
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    */

    withName: "^.*VCF_MERGE_CALLERS_JASMINE:JASMINESV\$" {
        ext.args = {[
            meta.variant_type == "sv" ? "min_support=${params.sv_callers_support}" : "",
            meta.variant_type == "cnv" ? "min_support=${params.cnv_callers_support}" : "",
            "--allow_intrasample"
        ].join(' ').trim()}
    }

    withName: "^.*VCF_MERGE_CALLERS_JASMINE:FIX_CALLERS\$" {
        ext.prefix = { "${meta.id}.callers-corrected" }
    }

    withName: "^.*VCF_MERGE_CALLERS_JASMINE:BCFTOOLS_CONSENSUS_REHEADER\$" {
        ext.prefix = { "${meta.id}.reheadered" }
    }

    withName: "^.*VCF_MERGE_CALLERS_JASMINE:BCFTOOLS_SORT\$" {
        ext.prefix = { "${meta.id}.${meta.variant_type}" }
    }

    /*
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        ANNOTATION
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    */

    withName: "^.*VCF_ANNOTATE_VEP_ANNOTSV:BCFTOOLS_FILTER\$" {
        ext.prefix = {"${meta.id}.filter"}
        ext.args = "-e 'GT=\"ref\"' --output-type z"
    }

    withName: "^.*VCF_ANNOTATE_VEP_ANNOTSV:ANNOTSV_ANNOTSV\$" {
        ext.args = {[
            "-SVminSize 20",
            "-vcf 1",
            meta.hpo ? "-hpo ${meta.hpo}" : ""
        ].join(" ")}
        ext.prefix = {"${meta.id}.annot"}
    }

    withName: "^.*VCF_ANNOTATE_VEP_ANNOTSV:BCFTOOLS_CONCAT\$" {
        ext.prefix = "annotsv_annotated"
        ext.args = "--output-type z --naive-force"
    }

    withName: "^.*VCF_ANNOTATE_VEP_ANNOTSV:ENSEMBLVEP_VEP\$" {
        ext.prefix = {"${meta.id}.vep"}
        ext.args = {[
            // specify we use VCF files
            '--format vcf',
            // don't contact external db
            '--offline',
            // increase buffer_size to speed up analysis
            '--buffer_size 100000',
            // output format options
            '--vcf --compress_output bgzip --force_overwrite',
            // co-located variant info
            '--check_existing',
            // specific options for structural variants
            '--overlaps', // TODO define the best configuration for --max_sv_size, --batch_size, --check_svs and --database
            // annotations
            '--regulatory --pubmed --symbol --hgvsg --hgvs --af_gnomadg --sift s',
            // create stats file
            "--stats_file ${prefix}.summary.html",
            // proteins
            '--domains --biotype --canonical --mane --ccds --protein --polyphen s --sift s'
        ].join(' ').trim()}
    }

    withName: "^.*VCF_ANNOTATE_VCFANNO:VCFANNO\$" {
        ext.args = "-permissive-overlap -ends"
    }

    withName: "^.*VCF_ANNOTATE_VCFANNO:BCFTOOLS_FILTER\$" {
        ext.prefix = {"${meta.id}.${meta.variant_type}.annotated"}
        ext.args = "${params.annotations_filter} --output-type z --write-index=tbi"
    }

    /*
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        REPEAT ESTIMATION
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    */

    withName: "^.*BAM_REPEAT_ESTIMATION_EXPANSIONHUNTER:EXPANSIONHUNTER\$" {
        ext.args = {"--sex ${meta.sex}"}
    }

    withName: "^.*BAM_REPEAT_ESTIMATION_EXPANSIONHUNTER:BCFTOOLS_ANNOTATE\$" {
        ext.args = "-c INFO/REPREF:=INFO/REF --output-type z"
        ext.prefix = { "${meta.id}.expansionhunter" }
        ext.tabix = true
    }

    /*
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        CONCAT OUTPUTS
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    */

    withName: "^.*VCF_CONCAT_BCFTOOLS:BCFTOOLS_CONCAT\$" {
        ext.args = "--output-type z --allow-overlaps"
    }

    /*
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        MERGE FAMILY SAMPLES
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    */

    withName: "^.*VCF_MERGE_FAMILY_JASMINE:JASMINESV\$" {
        ext.args = "--output_genotypes"
    }

    withName: "^.*VCF_MERGE_FAMILY_JASMINE:FIX_CALLERS\$" {
        ext.prefix = { "${meta.id}.callers-corrected" }
    }

    withName: "^.*VCF_MERGE_FAMILY_JASMINE:BCFTOOLS_CONSENSUS_REHEADER\$" {
        ext.prefix = { "${meta.id}.reheadered" }
    }

    withName: "^.*VCF_MERGE_FAMILY_JASMINE:BCFTOOLS_SORT\$" {
        ext.args = "--output-type z"
    }

    /*
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        REST OF THE PIPELINE
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    */

    withName: 'MULTIQC' {
        ext.args   = { params.multiqc_title ? "--title \"$params.multiqc_title\"" : '' }
    }

}
